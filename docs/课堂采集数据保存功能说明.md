# 课堂采集数据保存和文字稿查看功能

## 功能概述

课堂采集器现在支持完整的数据保存和查看功能，包括：

1. **数据持久化存储**：采集的课堂数据自动保存到 MongoDB 数据库
2. **文字稿自动生成**：实时转写的语音内容保存为结构化文字稿
3. **历史记录查询**：查看所有历史课堂采集记录
4. **文字稿详细查看**：按时间线展示完整的课堂对话记录
5. **数据导出**：支持导出文字稿为文本文件

## 数据结构

### ClassSession（课堂会话）

```typescript
interface ClassSession {
  id: string;                    // 会话唯一ID
  teacherId: string;             // 教师ID
  courseName: string;            // 课程名称
  className: string;             // 班级
  subject: string;               // 科目
  grade: string;                 // 年级
  objectives?: string;           // 课堂目标
  startTime: Date;               // 开始时间
  endTime?: Date;                // 结束时间
  duration: number;              // 时长（秒）
  status: SessionStatus;         // 状态
  audioUrl?: string;             // 音频文件URL
  transcriptCount?: number;      // 文字稿段落数
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
}
```

### TranscriptSegment（文字稿片段）

```typescript
interface TranscriptSegment {
  id: string;                    // 片段唯一ID
  sessionId: string;             // 所属会话ID
  timestamp: number;             // 相对时间戳（秒）
  speaker: SpeakerRole;          // 说话人角色（教师/学生）
  speakerName?: string;          // 说话人名称
  text: string;                  // 文字内容
  sentiment?: number;            // 情感分数（-1到1）
  keywords?: string[];           // 关键词
  confidence?: number;           // 识别置信度（0-1）
  createdAt: Date;               // 创建时间
}
```

## API 接口

### 后端接口

#### 1. 创建课堂会话
```
POST /api/collection/sessions
```

**请求体：**
```json
{
  "courseName": "《红楼梦》人物分析",
  "subject": "语文",
  "className": "高一（3）班",
  "grade": "高一",
  "objectives": "理解林黛玉的人物性格"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "id": "session_xxx",
    "status": "recording",
    ...
  }
}
```

#### 2. 获取会话列表
```
GET /api/collection/sessions?page=1&pageSize=10&status=completed
```

**响应：**
```json
{
  "success": true,
  "data": {
    "sessions": [...],
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "hasMore": true
  }
}
```

#### 3. 获取会话详情（含文字稿）
```
GET /api/collection/sessions/:id/full
```

**响应：**
```json
{
  "success": true,
  "data": {
    "id": "session_xxx",
    "courseName": "...",
    "transcript": [
      {
        "id": "transcript_xxx",
        "timestamp": 0,
        "speaker": "teacher",
        "text": "...",
        ...
      }
    ],
    ...
  }
}
```

#### 4. 获取文字稿
```
GET /api/collection/sessions/:id/transcript
```

#### 5. 停止会话
```
POST /api/collection/sessions/:id/stop
```

#### 6. 完成会话
```
POST /api/collection/sessions/:id/complete
```

**请求体：**
```json
{
  "audioUrl": "https://..."  // 可选
}
```

#### 7. 保存文字稿片段
```
POST /api/collection/sessions/:id/transcript
```

**请求体：**
```json
{
  "segments": [
    {
      "timestamp": 0,
      "speaker": "teacher",
      "text": "同学们好",
      "confidence": 0.95
    }
  ]
}
```

#### 8. 删除会话
```
DELETE /api/collection/sessions/:id
```

#### 9. 生成模拟文字稿（演示用）
```
POST /api/collection/sessions/:id/generate-mock-transcript
```

## 前端页面

### 1. 课堂采集器 (`/m1/recorder`)

**文件：** `frontend/src/pages/M1/ClassRecorder.tsx`

**功能：**
- 填写课堂基本信息
- 开始/停止课堂采集
- 自动保存会话数据
- 生成模拟文字稿
- 跳转到文字稿查看和历史记录

**使用流程：**
1. 填写课程名称、科目、班级等信息
2. 点击"开始课堂采集"
3. 系统自动创建会话并保存到数据库
4. 录制过程中可以看到实时计时
5. 点击"停止采集"结束录制
6. 系统自动生成文字稿并完成处理
7. 可选择查看文字稿或历史记录

### 2. 历史记录列表 (`/m1/sessions`)

**文件：** `frontend/src/pages/M1/SessionHistory.tsx`

**功能：**
- 展示所有历史课堂记录
- 按状态筛选（录制中/处理中/已完成/失败）
- 搜索课程、班级或科目
- 查看文字稿
- 查看分析报告
- 删除记录

**特性：**
- 分页显示
- 实时刷新
- 状态标签展示
- 快速操作按钮

### 3. 文字稿查看器 (`/m1/transcript/:id`)

**文件：** `frontend/src/pages/M1/TranscriptViewer.tsx`

**功能：**
- 展示课堂基本信息
- 统计数据（总对话数、教师发言、学生发言、总字数）
- 时间线展示文字稿
- 按说话人筛选
- 搜索文字内容
- 导出为文本文件

**特性：**
- 时间轴展示对话流程
- 角色标签区分教师和学生
- 关键词高亮显示
- 置信度展示
- 响应式设计

## 数据库集合

### 1. class_sessions

存储课堂会话的基本信息。

**索引：**
- `id`: 唯一索引
- `teacherId`: 普通索引
- `status`: 普通索引
- `createdAt`: 降序索引

### 2. transcripts

存储文字稿片段。

**索引：**
- `id`: 唯一索引
- `sessionId`: 普通索引
- `timestamp`: 升序索引（用于排序）

## 使用示例

### 1. 完整的采集流程

```typescript
// 1. 创建会话
const createResponse = await fetch('/api/collection/sessions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    courseName: '《红楼梦》人物分析',
    subject: '语文',
    className: '高一（3）班',
    grade: '高一',
  })
});
const { data: session } = await createResponse.json();

// 2. 采集音频并转写（实际项目中需要集成语音识别服务）
// ...

// 3. 保存文字稿片段
await fetch(`/api/collection/sessions/${session.id}/transcript`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    segments: [
      {
        timestamp: 0,
        speaker: 'teacher',
        text: '同学们好',
        confidence: 0.95
      }
    ]
  })
});

// 4. 停止会话
await fetch(`/api/collection/sessions/${session.id}/stop`, {
  method: 'POST'
});

// 5. 完成处理
await fetch(`/api/collection/sessions/${session.id}/complete`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ audioUrl: 'https://...' })
});
```

### 2. 查询和展示

```typescript
// 获取历史记录
const listResponse = await fetch('/api/collection/sessions?page=1&pageSize=10');
const { data } = await listResponse.json();

// 获取完整会话（含文字稿）
const fullResponse = await fetch(`/api/collection/sessions/${sessionId}/full`);
const { data: sessionWithTranscript } = await fullResponse.json();

// 导出文字稿
const exportContent = sessionWithTranscript.transcript
  .map(seg => `[${formatTime(seg.timestamp)}] ${seg.speakerName}: ${seg.text}`)
  .join('\n');
```

## 数据安全

1. **AES-256 加密**：敏感数据加密存储
2. **自动脱敏**：学生姓名等个人信息自动脱敏
3. **随时删除**：支持一键删除会话及相关数据
4. **访问控制**：仅授权教师可访问自己的课堂记录

## 后续扩展

### 计划功能：

1. **实时语音识别集成**
   - 集成阿里云、腾讯云等语音识别服务
   - 实时转写和保存

2. **音频文件存储**
   - 集成 OSS 对象存储
   - 音频回放功能

3. **智能分析**
   - 情感分析
   - 关键词提取
   - 互动热力图

4. **协作功能**
   - 文字稿标注
   - 教研组共享
   - 评论和讨论

5. **数据分析**
   - 教学风格分析
   - 学生参与度统计
   - 趋势对比

## 故障排查

### 常见问题

1. **创建会话失败**
   - 检查 MongoDB 连接状态
   - 确认必填字段已填写

2. **文字稿无法加载**
   - 检查会话ID是否正确
   - 确认会话状态为 COMPLETED

3. **导出失败**
   - 检查浏览器是否支持 Blob API
   - 确认有足够的文字稿数据

## 技术栈

- **后端：** Node.js + Express + TypeScript
- **数据库：** MongoDB
- **前端：** React + TypeScript + Ant Design
- **状态管理：** React Hooks
- **路由：** React Router

## 总结

该功能为课堂采集器提供了完整的数据持久化和查看能力，教师可以：

1. 记录每一节课的完整数据
2. 随时回顾课堂对话内容
3. 分析教学效果
4. 导出和分享文字稿
5. 管理历史记录

这为后续的智能分析和教学改进提供了坚实的数据基础。
