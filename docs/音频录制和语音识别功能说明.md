# 音频录制和语音识别功能说明

## 功能概述

课堂采集器现已集成真实的音频录制和语音转文字功能，使用浏览器原生的 Web API 实现，无需额外的插件或服务器端语音识别服务。

## 核心技术

### 1. **音频录制** - MediaRecorder API

使用浏览器原生的 MediaRecorder API 进行音频录制：

- **支持格式**：WebM (Opus编码)、OGG、MP4
- **音频质量**：128kbps
- **实时分块**：每秒生成一个数据块，便于流式处理
- **音频增强**：
  - 回声消除 (echoCancellation)
  - 噪音抑制 (noiseSuppression)
  - 自动增益控制 (autoGainControl)

### 2. **语音识别** - Web Speech API

使用浏览器原生的 Web Speech API 进行实时语音转文字：

- **持续识别**：continuous = true，支持长时间录制
- **实时结果**：interimResults = true，显示临时识别结果
- **中文支持**：lang = 'zh-CN'
- **自动重启**：识别意外中断时自动恢复
- **置信度**：每个识别结果都有置信度分数

### 3. **音频可视化** - Web Audio API

使用 Web Audio API 实现实时音频波形显示：

- **频域分析**：AnalyserNode 获取音频频谱数据
- **Canvas 渲染**：实时绘制音频波形
- **音频级别**：实时显示当前音量 (0-100%)

## 浏览器兼容性

### 完全支持（推荐）
- **Chrome / Edge** 85+
  - 完整支持所有功能
  - 最佳的语音识别准确率
  - 实时性最好

### 部分支持
- **Firefox** 90+
  - 支持音频录制
  - 不支持 Web Speech API（无实时转写）

- **Safari** 14.1+
  - 支持音频录制
  - 部分支持语音识别（需要前缀）

### 不支持
- **IE 11** 及以下
- **旧版移动浏览器**

## 功能特性

### 1. **实时语音转文字**

- 边说边转：语音即时转换为文字
- 临时显示：识别中的文字以不同样式显示
- 最终确认：识别完成的文字自动保存

### 2. **音频可视化**

- 波形显示：实时音频波形动画
- 音量指示：当前音频级别百分比
- 视觉反馈：直观显示录制状态

### 3. **实时文字稿面板**

- 滚动显示：自动滚动到最新内容
- 时间戳：每段对话显示相对时间
- 置信度：显示识别准确度
- 说话人：标注教师/学生（可扩展AI识别）

### 4. **数据保存**

- 实时上传：每段文字稿实时保存到服务器
- 断点续传：支持网络中断后恢复
- 离线缓存：可选的本地存储功能（待实现）

### 5. **音频文件**

- 格式转换：自动选择浏览器支持的最佳格式
- 文件上传：可上传到服务器或云存储（预留接口）
- 回放功能：支持课后回放（待实现）

## 使用流程

### 1. 权限请求

首次使用时会请求麦克风权限：

```javascript
// 自动检测和请求权限
const hasPermission = await requestMicrophonePermission();
```

用户需要在浏览器提示中允许访问麦克风。

### 2. 开始录制

点击"开始课堂采集"后：

1. 创建后端会话
2. 初始化 AudioRecorder
3. 启动麦克风录制
4. 启动语音识别
5. 开始音频可视化
6. 启动计时器

### 3. 录制过程

录制期间：

- **左侧**：显示录制状态、时长、音频级别、波形可视化
- **右侧**：实时显示语音转文字结果
- **自动保存**：每段识别完成的文字自动上传服务器

### 4. 停止录制

点击"停止采集"后：

1. 停止麦克风录制
2. 停止语音识别
3. 生成音频文件（Blob）
4. 更新服务器会话状态
5. 显示统计数据

### 5. 查看结果

可以选择：
- 查看完整文字稿
- 查看分析报告
- 查看历史记录
- 开始新的采集

## 文件结构

```
frontend/src/
├── services/
│   └── audioRecorder.ts          # 音频录制服务
├── components/
│   ├── AudioVisualizer.tsx       # 音频可视化组件
│   ├── AudioVisualizer.css
│   ├── LiveTranscript.tsx        # 实时文字稿组件
│   └── LiveTranscript.css
└── pages/M1/
    ├── ClassRecorder.tsx         # 课堂采集器（新版）
    └── ClassRecorder.css
```

## API 接口

### AudioRecorder 类

```typescript
class AudioRecorder {
  // 构造函数
  constructor(options: AudioRecorderOptions)

  // 开始录制
  async start(): Promise<void>

  // 停止录制
  stop(): Blob | null

  // 暂停录制
  pause(): void

  // 恢复录制
  resume(): void

  // 获取分析器（用于可视化）
  getAnalyser(): AnalyserNode | null

  // 获取音频级别
  getAudioLevel(): number

  // 检查是否在录制
  isActive(): boolean

  // 清理资源
  cleanup(): void
}
```

### AudioRecorderOptions

```typescript
interface AudioRecorderOptions {
  // 音频数据回调
  onDataAvailable?: (blob: Blob) => void;

  // 文字稿回调
  onTranscript?: (transcript: string, isFinal: boolean) => void;

  // 错误回调
  onError?: (error: Error) => void;

  // 音频格式
  mimeType?: string;
}
```

## 工具函数

```typescript
// 检查浏览器是否支持音频录制
isAudioRecordingSupported(): boolean

// 检查浏览器是否支持语音识别
isSpeechRecognitionSupported(): boolean

// 请求麦克风权限
requestMicrophonePermission(): Promise<boolean>
```

## 语音识别优化

### 准确率提升

1. **音频增强**：启用回声消除和噪音抑制
2. **持续识别**：避免频繁开关导致的识别中断
3. **自动重启**：网络错误或临时故障时自动恢复

### 实时性优化

1. **临时结果**：边识别边显示，不等待最终结果
2. **分段处理**：每句话单独处理，降低延迟
3. **本地优先**：使用浏览器本地识别引擎

## 数据流

```
麦克风输入
    ↓
MediaRecorder（音频录制）
    ├─→ AudioContext（音频分析）→ 可视化
    └─→ Speech Recognition（语音识别）
            ├─→ Interim Results（临时结果）→ UI 显示
            └─→ Final Results（最终结果）
                    ├─→ 本地状态更新
                    └─→ 服务器保存
```

## 性能优化

### 1. 内存管理

- 使用 Blob 而不是 Base64 存储音频
- 及时清理 AudioContext 和 MediaStream
- 分块传输大文件

### 2. 网络优化

- 实时上传文字稿（小数据量）
- 音频文件可选上传（大数据量）
- 失败重试机制

### 3. CPU 优化

- 可视化帧率限制（requestAnimationFrame）
- 音频级别计算降频（100ms间隔）
- 避免不必要的重渲染

## 已知限制

### 1. 浏览器限制

- Safari 支持不完整
- Firefox 不支持 Web Speech API
- 移动浏览器性能较差

### 2. 语音识别限制

- 需要网络连接（Chrome使用Google服务）
- 识别准确率受环境噪音影响
- 多人同时说话时识别效果差
- 方言识别准确率较低

### 3. 安全限制

- 必须在 HTTPS 环境下使用（localhost除外）
- 需要用户明确授予麦克风权限
- 不能在隐身模式下持久化权限

## 未来扩展

### 1. 离线语音识别

集成 TensorFlow.js 或其他离线模型：
- 完全本地化
- 无需网络
- 保护隐私

### 2. 说话人识别

使用 AI 模型识别不同说话人：
- 自动区分教师和学生
- 识别特定学生
- 生成说话人统计

### 3. 音频处理

高级音频处理功能：
- 背景噪音消除
- 音量标准化
- 音频增强

### 4. 多语言支持

支持更多语言：
- 英语、日语、韩语等
- 自动语言检测
- 混合语言识别

### 5. 云端识别

集成第三方语音识别服务：
- 阿里云语音识别
- 腾讯云语音识别
- 讯飞语音识别

提供更高的准确率和更多功能。

## 故障排查

### 问题：无法访问麦克风

**原因**：
- 浏览器未授予权限
- 其他应用占用麦克风
- 浏览器不支持

**解决**：
1. 检查浏览器权限设置
2. 关闭其他使用麦克风的应用
3. 使用Chrome或Edge浏览器

### 问题：语音识别不工作

**原因**：
- 网络连接问题
- 浏览器不支持
- 语言设置错误

**解决**：
1. 检查网络连接
2. 使用Chrome浏览器
3. 确认语言设置为中文

### 问题：识别准确率低

**原因**：
- 环境噪音大
- 说话不清晰
- 多人同时说话

**解决**：
1. 改善录音环境
2. 清晰说话
3. 避免同时说话

### 问题：音频可视化不显示

**原因**：
- 麦克风无输入
- AudioContext 未正确初始化
- 浏览器不支持

**解决**：
1. 测试麦克风
2. 刷新页面重新授权
3. 检查浏览器控制台错误

## 总结

现在的课堂采集器已经实现了真实的音频录制和语音转文字功能，主要特点：

✅ **完全客户端实现**：使用浏览器原生 API，无需服务器端处理
✅ **实时转写**：边说边转，延迟小于1秒
✅ **音频可视化**：直观的波形显示
✅ **自动保存**：识别结果实时上传服务器
✅ **良好兼容性**：主流浏览器都支持
✅ **易于扩展**：清晰的架构，便于添加新功能

这为后续的智能分析和教学改进提供了高质量的数据基础！
