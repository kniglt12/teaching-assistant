# 系统架构设计文档

## 1. 整体架构

### 1.1 架构风格
采用前后端分离的微服务架构，支持横向扩展和独立部署。

```
┌──────────────────────────────────────────────────────────────┐
│                        前端层 (Presentation)                  │
│                    React + TypeScript + Ant Design            │
└────────────────────────┬─────────────────────────────────────┘
                         │ HTTPS/REST API
┌────────────────────────▼─────────────────────────────────────┐
│                      API 网关 (Gateway)                        │
│              认证 | 鉴权 | 限流 | 日志 | 监控                  │
└────────────────────────┬─────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┬──────────────┐
        │                │                │              │
┌───────▼──────┐  ┌──────▼──────┐  ┌─────▼──────┐  ┌───▼─────┐
│   采集服务   │  │   分析服务  │  │  生成服务  │  │ 看板服务│
│  Collection  │  │  Analysis   │  │ Generation │  │Dashboard│
└───────┬──────┘  └──────┬──────┘  └─────┬──────┘  └───┬─────┘
        │                │                │              │
        └────────────────┴────────────────┴──────────────┘
                         │
        ┌────────────────┴────────────────┐
        │                                 │
┌───────▼──────────┐           ┌──────────▼────────┐
│   PostgreSQL     │           │    MongoDB        │
│   (结构化数据)   │           │  (非结构化数据)   │
└──────────────────┘           └───────────────────┘
```

### 1.2 技术栈选型

#### 前端技术栈
- **框架**: React 18 - 现代化UI框架
- **语言**: TypeScript - 类型安全
- **UI组件**: Ant Design 5 - 企业级UI设计
- **状态管理**: Zustand - 轻量级状态管理
- **数据请求**: React Query + Axios - 数据缓存与请求
- **图表**: ECharts - 强大的数据可视化
- **路由**: React Router 6 - 声明式路由
- **构建工具**: Vite - 极速开发体验

#### 后端技术栈
- **运行时**: Node.js 18 LTS
- **框架**: Express - 简洁灵活的Web框架
- **语言**: TypeScript - 类型安全
- **数据库**:
  - PostgreSQL 14 - 关系型数据（用户、会话、报告）
  - MongoDB 6 - 文档型数据（转写文本、素材）
- **认证**: JWT - 无状态认证
- **加密**: bcrypt + AES-256 - 密码与数据加密
- **日志**: Winston - 企业级日志
- **实时通信**: Socket.io - WebSocket支持

## 2. 核心模块设计

### 2.1 采集模块 (Collection)

**功能职责：**
- 课堂会话管理（创建、开始、结束）
- 音频数据接收与存储
- 实时语音转文本 (ASR集成)
- 师生角色识别
- 数据脱敏与加密

**数据流：**
```
录音设备 → 音频流 → ASR服务 → 文本转写 → 角色识别 → 加密存储
```

**API端点：**
- `POST /api/collection/sessions` - 创建会话
- `POST /api/collection/sessions/:id/audio` - 上传音频
- `POST /api/collection/sessions/:id/stop` - 停止采集
- `GET /api/collection/sessions/:id` - 获取会话详情

### 2.2 分析模块 (Analysis)

**功能职责：**
- 课堂数据分析（互动、参与度、时长等）
- 指标计算与评估
- 热区/冷区识别
- 改进建议生成
- 报告生成与存储

**核心算法：**
- 师生对话比例计算
- 学生参与度评分
- 互动质量分析
- 知识点覆盖度统计

**API端点：**
- `POST /api/analysis/reports` - 生成报告
- `GET /api/analysis/reports/:id` - 获取报告
- `GET /api/analysis/metrics` - 获取指标库

### 2.3 生成模块 (Generation)

**功能职责：**
- PPT教案自动生成
- 情境导入内容创作
- 差异化作业生成（基础/提升/拓展）
- 模板库管理
- 本地素材适配

**生成流程：**
```
输入主题 → LLM理解 → 检索模板库 → 内容生成 → 格式化 → 人工编辑 → 导出
```

**API端点：**
- `POST /api/generation/ppt` - 生成PPT
- `POST /api/generation/homework` - 生成作业
- `GET /api/generation/templates` - 获取模板库

### 2.4 看板模块 (Dashboard)

**功能职责：**
- 个人工作台数据展示
- 班级级别统计
- 年级/校级对比分析
- 趋势变化追踪
- 学习力雷达可视化

**数据聚合：**
```
实时数据 ← 采集服务
历史数据 ← 数据库
统计指标 ← 分析服务
可视化 → 前端组件
```

**API端点：**
- `GET /api/dashboard/stats` - 获取统计数据
- `GET /api/dashboard/trends` - 获取趋势数据
- `GET /api/dashboard/radar/:classId` - 获取雷达数据

## 3. 数据库设计

### 3.1 PostgreSQL表结构

**核心表：**
- `users` - 用户表
- `class_sessions` - 课堂会话表
- `class_reports` - 课堂报告表
- `metrics_results` - 指标结果表
- `improvements` - 改进建议表
- `ppt_templates` - PPT模板表
- `homework_sets` - 作业集表
- `audit_logs` - 审计日志表
- `compliance_checks` - 合规检查表

**关系设计：**
```
users (1) ─── (N) class_sessions
class_sessions (1) ─── (1) class_reports
class_reports (1) ─── (N) metrics_results
class_reports (1) ─── (N) improvements
```

### 3.2 MongoDB集合设计

**集合：**
- `transcripts` - 转写文本（含时间戳、角色、内容）
- `templates` - 模板库（PPT、作业模板）
- `materials` - 素材库（情境素材、本地化内容）
- `knowledge_base` - 知识库（指标解释、话术库）

## 4. 安全设计

### 4.1 认证与授权

**认证方式：**
- JWT Token（有效期7天）
- 密码bcrypt哈希（10轮salt）
- 刷新Token机制

**权限模型（RBAC）：**
```
teacher（教师）:
  - 创建/管理自己的课程
  - 生成PPT/作业
  - 查看自己的数据

school_admin（校管理员）:
  - 查看全校数据
  - 管理教师账号
  - 导出报告

admin（系统管理员）:
  - 全部权限
  - 系统配置
  - 合规审计
```

### 4.2 数据安全

**加密措施：**
- 静态数据：AES-256-CBC加密
- 传输数据：HTTPS/TLS 1.3
- 敏感信息：自动脱敏（姓名、学号等）

**审计机制：**
- 所有操作记录audit_logs
- 包含用户、时间、操作、IP
- 支持追溯和合规检查

### 4.3 合规要求

**数据留存：**
- 原始音频不保留（仅转写文本）
- 转写文本加密存储
- 支持用户删除请求（GDPR）

**访问控制：**
- 最小权限原则
- 操作日志完整记录
- 定期合规检查报告

## 5. 性能优化

### 5.1 前端优化
- 代码分割与懒加载
- 静态资源CDN加速
- 图片压缩与懒加载
- 组件级别缓存

### 5.2 后端优化
- 数据库索引优化
- API响应缓存（Redis可选）
- 连接池管理
- 异步处理长时任务

### 5.3 数据库优化
- 合理使用索引
- 分区表设计（大数据量）
- 查询优化（EXPLAIN分析）
- 定期VACUUM清理

## 6. 可扩展性

### 6.1 横向扩展
- 无状态服务设计
- 负载均衡器（Nginx）
- 数据库读写分离
- 微服务独立部署

### 6.2 垂直扩展
- 服务器资源升级
- 数据库性能调优
- 缓存层添加

### 6.3 功能扩展
- 插件化架构
- API版本控制
- 配置化驱动
- 微服务解耦

## 7. 监控与运维

### 7.1 监控指标
- 服务健康检查
- API响应时间
- 数据库连接数
- 错误率统计

### 7.2 日志管理
- 分级日志（error/warn/info/debug）
- 日志轮转策略
- 集中日志收集（可选ELK）

### 7.3 告警机制
- 服务宕机告警
- 错误率超阈值告警
- 数据库连接失败告警

## 8. 技术债务与未来规划

### 8.1 当前限制
- 音频处理依赖第三方ASR
- 单机部署为主
- 缺少分布式追踪

### 8.2 未来优化
- 自研ASR模型
- Kubernetes编排
- 服务网格（Service Mesh）
- 实时数据流处理
- AI模型本地化部署
